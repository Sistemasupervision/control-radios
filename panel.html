<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel | Control de Radios</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    /* === COPIA TODO EL CSS DE TU panel.txt AQUÍ === */
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; }
    body { background-image: url('fondo.png'); background-size: cover; background-position: right top; background-repeat: no-repeat; color: #0d47a1; padding: 20px; min-height: 100vh; }
    .container { max-width: 1000px; margin: 0 auto; background: rgba(255, 255, 255, 0.92); border-radius: 16px; padding: 30px; box-shadow: 0 6px 25px rgba(0,0,0,0.12); }
    .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; }
    .header-left { text-align: center; flex: 1; }
    .logo-img { max-width: 90px; margin-bottom: 12px; }
    .header h1 { font-size: 24px; font-weight: 600; color: #0d47a1; }
    .logout-btn { background: #d32f2f; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 500; }
    .tabs { display: flex; border-bottom: 1px solid #e0e0e0; margin-bottom: 24px; }
    .tab { padding: 12px 24px; cursor: pointer; font-weight: 600; color: #90a4ae; border-bottom: 3px solid transparent; }
    .tab.active { color: #1976d2; border-bottom: 3px solid #1976d2; }
    #content-container { min-height: 300px; }
    .search-box { margin-bottom: 20px; }
    #searchInput { width: 100%; padding: 12px; border: 1px solid #90a4ae; border-radius: 8px; font-size: 15px; }
    .radio-list { display: flex; flex-direction: column; gap: 12px; }
    .radio-item { background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 10px; padding: 14px; display: flex; justify-content: space-between; }
    .radio-info p { margin: 4px 0; font-size: 14px; }
    .radio-id { font-weight: 600; color: #1976d2; }
    .radio-serial { font-family: monospace; color: #0d47a1; }
    .radio-meta { text-align: right; min-width: 160px; color: #666; font-size: 13px; }
    .form-group { margin-bottom: 18px; }
    .form-group label { display: block; margin-bottom: 6px; font-weight: 500; color: #37474f; }
    .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #90a4ae; border-radius: 8px; font-size: 15px; color: #263238; }
    .message { padding: 10px; margin: 12px 0; border-radius: 6px; font-size: 14px; }
    .message.success { background: #e8f5e9; color: #2e7d32; }
    .message.error { background: #ffebee; color: #c62828; }
    .btn { background: #1976d2; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 15px; }
    .btn:hover { background: #1565c0; }
    .info-section p { margin: 12px 0; line-height: 1.5; }
    hr { border: 0; border-top: 1px solid #e0e0e0; margin: 16px 0; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-left">
        <img src="logo.png" alt="Logo CPNB" class="logo-img" onerror="this.style.display='none'">
        <h1>Control de Radios – CPNB</h1>
      </div>
      <button class="logout-btn" id="logoutBtn">Salir</button>
    </div>
    <div class="tabs">
      <div class="tab active" data-tab="consulta">Consulta</div>
      <div class="tab" data-tab="registro">Registro</div>
      <div class="tab" data-tab="informacion">Información</div>
    </div>
    <div id="content-container"></div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabaseUrl = 'https://rgaplyddikcbygzzdpgx.supabase.co';
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJnYXBseWRkaWtjYnlnenpkcGd4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMDY1MDUsImV4cCI6MjA3NzY4MjUwNX0.G8SXKZm2OjJZSclkMiR8o4p9r0pHhmoN3NU0pLMrVF8';
    const supabase = createClient(supabaseUrl, supabaseAnonKey);

    // Verificar autenticación
    (async () => {
      try {
        const { data } = await supabase.auth.getUser();
        if (!data.user) window.location.href = 'index.html';
      } catch (err) {
        window.location.href = 'index.html';
      }
    })();

    // --- FUNCIONES DE CADA PESTAÑA ---

    // Consulta
    async function loadRadios() {
      const term = document.getElementById('searchInput')?.value?.trim().toLowerCase() || '';
      let query = supabase.from('radios').select('*').order('created_at', { ascending: true });
      if (term) {
        query = query.or(`serial.ilike.%${term}%,codigo_id.ilike.%${term}%`);
      }
      const { data, error } = await query;
      const list = document.getElementById('radioList');
      if (!list) return;
      if (error) {
        list.innerHTML = '<div class="message error">Error al cargar el inventario.</div>';
        return;
      }
      list.innerHTML = data.map(r => `
        <div class="radio-item">
          <div class="radio-info">
            <p><span class="radio-id">#${r.numero} • ${r.marca} ${r.modelo}</span></p>
            <p class="radio-serial">Serial: ${r.serial}</p>
            <p>ID: ${r.codigo_id || '—'} | Dependencia: ${r.dependencia || '—'}</p>
            <p><strong>Status:</strong> ${r.status} ${r.motivo_inoperativo ? `– ${r.motivo_inoperativo}` : ''}</p>
          </div>
          <div class="radio-meta">
            <p>${r.tipo_equipo}</p>
            ${r.observaciones ? `<p>Obs: ${r.observaciones}</p>` : ''}
            <p style="font-size:11px; color:#999;">${new Date(r.created_at).toLocaleString('es-VE')}</p>
          </div>
        </div>
      `).join('');
    }

    // Registro – Lógica completa
    let serialTimeout = null;
    let idTimeout = null;

    function initRegistro() {
      // Limpiar eventos previos (evitar duplicados)
      const registerBtn = document.getElementById('registerBtn');
      const statusSelect = document.getElementById('reg_status');
      const serialInput = document.getElementById('reg_serial');
      const idInput = document.getElementById('reg_codigo_id');

      if (!registerBtn || !statusSelect) return;

      // Mostrar/ocultar motivo
      statusSelect.addEventListener('change', () => {
        const motivoGroup = document.getElementById('motivoGroup');
        if (statusSelect.value === 'Inoperativo') {
          motivoGroup.style.display = 'block';
        } else {
          motivoGroup.style.display = 'none';
          document.getElementById('reg_motivo').value = '';
        }
      });

      // Validación en tiempo real
      serialInput.addEventListener('input', () => {
        const serial = serialInput.value.trim();
        const msgDiv = document.getElementById('serial-message');
        msgDiv.textContent = '';
        if (!serial) return;
        if (serialTimeout) clearTimeout(serialTimeout);
        serialTimeout = setTimeout(async () => {
          const { data, error } = await supabase.from('radios').select('serial').eq('serial', serial).single();
          if (error && error.code === 'PGRST116') {
            msgDiv.textContent = '✅ Disponible';
            msgDiv.style.color = '#2e7d32';
          } else if (data) {
            msgDiv.textContent = '¡Este serial ya se encuentra registrado!';
            msgDiv.style.color = '#d32f2f';
          }
        }, 500);
      });

      idInput.addEventListener('input', () => {
        const id = idInput.value.trim();
        const msgDiv = document.getElementById('id-message');
        msgDiv.textContent = '';
        if (!id) return;
        if (idTimeout) clearTimeout(idTimeout);
        idTimeout = setTimeout(async () => {
          const { data, error } = await supabase.from('radios').select('codigo_id').eq('codigo_id', id).single();
          if (error && error.code === 'PGRST116') {
            msgDiv.textContent = '✅ Disponible';
            msgDiv.style.color = '#2e7d32';
          } else if (data) {
            msgDiv.textContent = '¡Este Código ID ya está en uso!';
            msgDiv.style.color = '#d32f2f';
          }
        }, 500);
      });

      // Registrar
      registerBtn.onclick = async () => {
        const marca = document.getElementById('reg_marca').value;
        const modelo = document.getElementById('reg_modelo').value;
        const serial = document.getElementById('reg_serial').value.trim();
        const codigo_id = document.getElementById('reg_codigo_id').value.trim() || null;
        const dependencia = document.getElementById('reg_dependencia').value || null;
        const observaciones = document.getElementById('reg_observaciones').value || null;
        const tipo_equipo = document.getElementById('reg_tipo_equipo').value;
        const status = document.getElementById('reg_status').value;
        const motivo_inoperativo = status === 'Inoperativo' 
          ? (document.getElementById('reg_motivo').value.trim() || null) 
          : null;
        const msg = document.getElementById('registro-message');

        if (!marca || !modelo || !serial || !tipo_equipo || !status) {
          msg.innerHTML = '<div class="message error">Campos con * obligatorios.</div>';
          return;
        }
        if (status === 'Inoperativo' && !motivo_inoperativo) {
          msg.innerHTML = '<div class="message error">Indique el motivo de inoperatividad.</div>';
          return;
        }

        // Verificar duplicados
        const { data: sData, error: sErr } = await supabase.from('radios').select('serial').eq('serial', serial).single();
        if (!sErr) {
          document.getElementById('serial-message').textContent = '¡Este serial ya se encuentra registrado!';
          return;
        }
        if (codigo_id) {
          const { data: iData, error: iErr } = await supabase.from('radios').select('codigo_id').eq('codigo_id', codigo_id).single();
          if (!iErr) {
            document.getElementById('id-message').textContent = '¡Este Código ID ya está en uso!';
            return;
          }
        }

        // Obtener número
        const { data: radios } = await supabase
          .from('radios')
          .select('numero')
          .eq('tipo_equipo', tipo_equipo)
          .order('numero', { ascending: false })
          .limit(1);
        const nextNumero = radios.length > 0 ? radios[0].numero + 1 : 1;

        const { error } = await supabase.from('radios').insert([{
          numero: nextNumero,
          marca,
          modelo,
          serial,
          codigo_id,
          dependencia,
          observaciones,
          tipo_equipo,
          status,
          motivo_inoperativo
        }]);

        if (error) {
          msg.innerHTML = `<div class="message error">Error: ${error.message}</div>`;
        } else {
          msg.innerHTML = '<div class="message success">✅ Registrado correctamente.</div>';
          // Reset
          document.querySelectorAll('#registro input, #registro select').forEach(el => {
            if (el.id === 'reg_status') el.value = 'Operativo';
            else if (el.id !== 'registerBtn') el.value = '';
          });
          document.getElementById('motivoGroup').style.display = 'none';
          document.getElementById('serial-message').textContent = '';
          document.getElementById('id-message').textContent = '';
          setTimeout(() => msg.innerHTML = '', 4000);
          // Recargar consulta si está abierta
          if (document.querySelector('.tab.active').getAttribute('data-tab') === 'consulta') loadRadios();
        }
      };
    }

    // Información
    function initInformacion() {
      // Nada dinámico, solo HTML
    }

    // --- CARGA DINÁMICA DE PESTAÑAS ---
    async function loadTabContent(tabId) {
      try {
        const response = await fetch(`${tabId}.html`);
        if (!response.ok) throw new Error(`No se encontró ${tabId}.html`);
        const html = await response.text();
        document.getElementById('content-container').innerHTML = html;

        // Inicializar lógica específica
        if (tabId === 'consulta') {
          document.getElementById('searchInput')?.addEventListener('input', loadRadios);
          loadRadios();
        } else if (tabId === 'registro') {
          initRegistro();
        } else if (tabId === 'informacion') {
          initInformacion();
        }
      } catch (err) {
        document.getElementById('content-container').innerHTML = `<p class="message error">Error al cargar: ${err.message}</p>`;
      }
    }

    // Eventos de pestañas
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const tabId = tab.getAttribute('data-tab');
        loadTabContent(tabId);
      });
    });

    // Salir
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await supabase.auth.signOut();
      window.location.href = 'index.html';
    });

    // Cargar pestaña inicial
    loadTabContent('consulta');
  </script>
</body>
</html>
